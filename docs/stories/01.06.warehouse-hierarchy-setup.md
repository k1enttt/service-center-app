# Story 1.6: Warehouse Hierarchy Setup

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.06
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.1 (Foundation Setup)

---

## Story

**As a** warehouse manager,
**I want** to set up physical warehouse locations and virtual warehouse types,
**so that** I can organize inventory by location and purpose (warranty stock, RMA, dead stock, etc.).

---

## Acceptance Criteria

1. Tables `physical_warehouses` and `virtual_warehouses` already created by Story 1.1
2. Seed 5 default virtual warehouses with warehouse_type ENUM values:
   - Warranty Stock (warranty_stock)
   - RMA Staging Area (rma_staging)
   - Dead Stock (dead_stock)
   - In Service (in_service)
   - Parts Inventory (parts)
3. Create tRPC `warehouse` router with procedures:
   - `warehouse.listPhysical` - Get all physical warehouses
   - `warehouse.createPhysical` - Create physical warehouse
   - `warehouse.updatePhysical` - Update physical warehouse
   - `warehouse.deletePhysical` - Soft delete physical warehouse
   - `warehouse.listVirtual` - Get all virtual warehouses
4. Build admin UI at `/dashboard/warehouses`
5. Physical warehouse form: name, location, is_active toggle
6. Virtual warehouses are read-only (seeded, cannot be created/deleted by users)
7. List view shows: name, location, product count, is_active status
8. Validation: Cannot delete physical warehouse with products in stock

---

## Integration Verification

- **IV1**: Existing parts inventory functionality remains unchanged
- **IV2**: Warehouse setup does not affect ticket creation workflow
- **IV3**: Admin navigation includes new Warehouses section
- **IV4**: Virtual warehouse seeding is idempotent (safe to run multiple times)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] Seed virtual warehouses (AC: 2)
  - [ ] Create seed data file with 5 virtual warehouses
  - [ ] Warehouse Stock: "Products under active warranty"
  - [ ] RMA Staging: "Products awaiting return to supplier"
  - [ ] Dead Stock: "Non-functional products for parts harvesting"
  - [ ] In Service: "Products currently being serviced"
  - [ ] Parts: "Replacement parts and components"
  - [ ] Create migration or seed script to populate `virtual_warehouses` table
  - [ ] Make seed idempotent (check if records exist before inserting)

- [ ] Create tRPC warehouse router (AC: 3)
  - [ ] Create `src/server/routers/warehouse.ts`
  - [ ] Implement `warehouse.listPhysical` procedure with role check (Admin/Manager)
  - [ ] Implement `warehouse.createPhysical` procedure with validation
  - [ ] Implement `warehouse.updatePhysical` procedure
  - [ ] Implement `warehouse.deletePhysical` soft delete (set is_active = false)
  - [ ] Implement `warehouse.listVirtual` procedure
  - [ ] Add warehouse router to `src/server/routers/_app.ts`

- [ ] Add validation logic (AC: 8)
  - [ ] Check if physical warehouse has products before delete
  - [ ] Return error if deletion would affect inventory
  - [ ] Allow soft delete (is_active = false) as alternative

### Frontend Tasks

- [ ] Create type definitions
  - [ ] Define types in `src/types/warehouse.ts`
  - [ ] PhysicalWarehouse interface
  - [ ] VirtualWarehouse interface
  - [ ] WarehouseType enum

- [ ] Create warehouse custom hooks
  - [ ] Implement `src/hooks/use-warehouse.ts`
  - [ ] `usePhysicalWarehouses()` hook
  - [ ] `useVirtualWarehouses()` hook
  - [ ] `useWarehouseCreate()` mutation hook
  - [ ] `useWarehouseUpdate()` mutation hook
  - [ ] `useWarehouseDelete()` mutation hook

- [ ] Build warehouse management UI (AC: 4, 7)
  - [ ] Create `/dashboard/warehouses` route
  - [ ] Create tabbed interface: Physical Warehouses | Virtual Warehouses
  - [ ] Create `PhysicalWarehouseTable` component in `src/components/tables/`
  - [ ] Show name, location, product count, is_active status
  - [ ] Actions: Edit, Activate/Deactivate, Delete
  - [ ] Create `VirtualWarehouseTable` component (read-only)

- [ ] Build warehouse form modal (AC: 5)
  - [ ] Create `WarehouseFormModal` component in `src/components/modals/`
  - [ ] Form fields: name (required), location (required), is_active (toggle)
  - [ ] Validation: name min 3 characters, location min 5 characters
  - [ ] Handle create and edit modes

- [ ] Create warehouse constants (AC: 2)
  - [ ] Define in `src/constants/warehouse.ts`
  - [ ] Virtual warehouse type labels
  - [ ] Virtual warehouse descriptions
  - [ ] Warehouse status options

- [ ] Update navigation (IV3)
  - [ ] Add "Warehouses" menu item to sidebar
  - [ ] Ensure only Admin/Manager can see this menu
  - [ ] Add warehouse icon

### Integration & Testing Tasks

- [ ] Verify existing parts inventory (IV1)
  - [ ] Test existing parts CRUD operations
  - [ ] Verify parts stock adjustments still work
  - [ ] Verify parts list displays correctly

- [ ] Test ticket workflow independence (IV2)
  - [ ] Create service tickets
  - [ ] Verify ticket creation succeeds
  - [ ] Verify warehouse setup doesn't interfere

- [ ] Test virtual warehouse seeding (IV4)
  - [ ] Run seed script multiple times
  - [ ] Verify no duplicate records created
  - [ ] Verify all 5 warehouses exist

- [ ] Test physical warehouse CRUD
  - [ ] Create physical warehouse
  - [ ] Update warehouse details
  - [ ] Activate/deactivate warehouse
  - [ ] Delete warehouse (with and without products)

---

## Dev Notes

### Virtual Warehouses Seed Data

```sql
-- Seed virtual warehouses (idempotent)
INSERT INTO virtual_warehouses (id, name, warehouse_type, description)
VALUES
  (
    gen_random_uuid(),
    'Warranty Stock',
    'warranty_stock',
    'Products under active warranty available for replacement'
  ),
  (
    gen_random_uuid(),
    'RMA Staging Area',
    'rma_staging',
    'Products awaiting return to supplier or manufacturer'
  ),
  (
    gen_random_uuid(),
    'Dead Stock',
    'dead_stock',
    'Non-functional products for parts harvesting or disposal'
  ),
  (
    gen_random_uuid(),
    'In Service',
    'in_service',
    'Products currently being serviced or repaired'
  ),
  (
    gen_random_uuid(),
    'Parts Inventory',
    'parts',
    'Replacement parts and components inventory'
  )
ON CONFLICT (warehouse_type) DO NOTHING;
```

**Note:** Add unique constraint on `warehouse_type` in virtual_warehouses table for idempotency.

### tRPC Warehouse Router

```typescript
// src/server/routers/warehouse.ts

import { router, publicProcedure } from '../trpc';
import { TRPCError } from '@trpc/server';
import { z } from 'zod';

const physicalWarehouseSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters'),
  location: z.string().min(5, 'Location must be at least 5 characters'),
  is_active: z.boolean().default(true)
});

export const warehouseRouter = router({
  listPhysical: publicProcedure
    .query(async ({ ctx }) => {
      // Check role
      if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }

      const { data, error } = await ctx.supabaseAdmin
        .from('physical_warehouses')
        .select(`
          *,
          product_count:physical_products(count)
        `)
        .order('name', { ascending: true });

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return data;
    }),

  createPhysical: publicProcedure
    .input(physicalWarehouseSchema)
    .mutation(async ({ ctx, input }) => {
      if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }

      const { data, error } = await ctx.supabaseAdmin
        .from('physical_warehouses')
        .insert({
          ...input,
          created_by_id: ctx.user.id
        })
        .select()
        .single();

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return data;
    }),

  updatePhysical: publicProcedure
    .input(z.object({
      id: z.string().uuid(),
      data: physicalWarehouseSchema
    }))
    .mutation(async ({ ctx, input }) => {
      if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }

      const { data, error } = await ctx.supabaseAdmin
        .from('physical_warehouses')
        .update(input.data)
        .eq('id', input.id)
        .select()
        .single();

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return data;
    }),

  deletePhysical: publicProcedure
    .input(z.object({ id: z.string().uuid() }))
    .mutation(async ({ ctx, input }) => {
      if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }

      // Check if warehouse has products
      const { count } = await ctx.supabaseAdmin
        .from('physical_products')
        .select('id', { count: 'exact', head: true })
        .eq('physical_warehouse_id', input.id);

      if (count && count > 0) {
        throw new TRPCError({
          code: 'PRECONDITION_FAILED',
          message: `Cannot delete warehouse: ${count} product(s) in stock. Move or remove products first.`
        });
      }

      // Soft delete
      const { data, error } = await ctx.supabaseAdmin
        .from('physical_warehouses')
        .update({ is_active: false })
        .eq('id', input.id)
        .select()
        .single();

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return data;
    }),

  listVirtual: publicProcedure
    .query(async ({ ctx }) => {
      if (!ctx.user || !['admin', 'manager', 'technician'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }

      const { data, error } = await ctx.supabaseAdmin
        .from('virtual_warehouses')
        .select(`
          *,
          product_count:physical_products(count)
        `)
        .order('warehouse_type', { ascending: true });

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return data;
    })
});
```

### Type Definitions

```typescript
// src/types/warehouse.ts

export type WarehouseType =
  | 'warranty_stock'
  | 'rma_staging'
  | 'dead_stock'
  | 'in_service'
  | 'parts';

export interface PhysicalWarehouse {
  id: string;
  name: string;
  location: string;
  is_active: boolean;
  created_by_id: string;
  created_at: string;
  updated_at: string;
  product_count?: number;
}

export interface VirtualWarehouse {
  id: string;
  name: string;
  warehouse_type: WarehouseType;
  description: string;
  created_at: string;
  product_count?: number;
}
```

### Warehouse Constants

```typescript
// src/constants/warehouse.ts

export const WAREHOUSE_TYPE_LABELS: Record<WarehouseType, string> = {
  warranty_stock: 'Warranty Stock',
  rma_staging: 'RMA Staging Area',
  dead_stock: 'Dead Stock',
  in_service: 'In Service',
  parts: 'Parts Inventory'
};

export const WAREHOUSE_TYPE_DESCRIPTIONS: Record<WarehouseType, string> = {
  warranty_stock: 'Products under active warranty available for replacement',
  rma_staging: 'Products awaiting return to supplier or manufacturer',
  dead_stock: 'Non-functional products for parts harvesting or disposal',
  in_service: 'Products currently being serviced or repaired',
  parts: 'Replacement parts and components inventory'
};

export const WAREHOUSE_STATUS_OPTIONS = [
  { value: true, label: 'Active', variant: 'success' },
  { value: false, label: 'Inactive', variant: 'secondary' }
] as const;
```

### Custom Hooks

```typescript
// src/hooks/use-warehouse.ts

import { trpc } from '@/utils/trpc';

export function usePhysicalWarehouses() {
  return trpc.warehouse.listPhysical.useQuery();
}

export function useVirtualWarehouses() {
  return trpc.warehouse.listVirtual.useQuery();
}

export function useWarehouseCreate() {
  const utils = trpc.useUtils();

  return trpc.warehouse.createPhysical.useMutation({
    onSuccess: () => {
      utils.warehouse.listPhysical.invalidate();
    }
  });
}

export function useWarehouseUpdate() {
  const utils = trpc.useUtils();

  return trpc.warehouse.updatePhysical.useMutation({
    onSuccess: () => {
      utils.warehouse.listPhysical.invalidate();
    }
  });
}

export function useWarehouseDelete() {
  const utils = trpc.useUtils();

  return trpc.warehouse.deletePhysical.useMutation({
    onSuccess: () => {
      utils.warehouse.listPhysical.invalidate();
    }
  });
}
```

### Warehouse Management Page

```typescript
// app/(auth)/dashboard/warehouses/page.tsx

'use client';

import { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { PhysicalWarehouseTable } from '@/components/tables/physical-warehouse-table';
import { VirtualWarehouseTable } from '@/components/tables/virtual-warehouse-table';
import { WarehouseFormModal } from '@/components/modals/warehouse-form-modal';
import { Plus } from 'lucide-react';

export default function WarehousesPage() {
  const [showCreateModal, setShowCreateModal] = useState(false);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Warehouse Management</h1>
          <p className="text-muted-foreground">
            Manage physical locations and virtual inventory types
          </p>
        </div>
      </div>

      <Tabs defaultValue="physical" className="w-full">
        <div className="flex items-center justify-between mb-4">
          <TabsList>
            <TabsTrigger value="physical">Physical Warehouses</TabsTrigger>
            <TabsTrigger value="virtual">Virtual Warehouses</TabsTrigger>
          </TabsList>

          <Button onClick={() => setShowCreateModal(true)}>
            <Plus className="mr-2 h-4 w-4" />
            Add Physical Warehouse
          </Button>
        </div>

        <TabsContent value="physical" className="space-y-4">
          <PhysicalWarehouseTable />
        </TabsContent>

        <TabsContent value="virtual" className="space-y-4">
          <VirtualWarehouseTable />
        </TabsContent>
      </Tabs>

      <WarehouseFormModal
        open={showCreateModal}
        onClose={() => setShowCreateModal(false)}
      />
    </div>
  );
}
```

### Physical Warehouse Table Component

```typescript
// src/components/tables/physical-warehouse-table.tsx

'use client';

import { useState } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { usePhysicalWarehouses, useWarehouseDelete } from '@/hooks/use-warehouse';
import { WarehouseFormModal } from '@/components/modals/warehouse-form-modal';
import { Edit, Trash2 } from 'lucide-react';
import { toast } from 'sonner';
import type { PhysicalWarehouse } from '@/types/warehouse';

export function PhysicalWarehouseTable() {
  const { data: warehouses, isLoading } = usePhysicalWarehouses();
  const deleteWarehouse = useWarehouseDelete();
  const [editWarehouse, setEditWarehouse] = useState<PhysicalWarehouse | null>(null);

  const handleDelete = async (id: string) => {
    if (!confirm('Are you sure you want to delete this warehouse?')) return;

    try {
      await deleteWarehouse.mutateAsync({ id });
      toast.success('Warehouse deactivated successfully');
    } catch (error) {
      toast.error(error.message || 'Failed to delete warehouse');
    }
  };

  if (isLoading) return <div>Loading...</div>;

  return (
    <>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Name</TableHead>
            <TableHead>Location</TableHead>
            <TableHead>Products</TableHead>
            <TableHead>Status</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {warehouses?.map((warehouse) => (
            <TableRow key={warehouse.id}>
              <TableCell className="font-medium">{warehouse.name}</TableCell>
              <TableCell>{warehouse.location}</TableCell>
              <TableCell>{warehouse.product_count || 0}</TableCell>
              <TableCell>
                <Badge variant={warehouse.is_active ? 'success' : 'secondary'}>
                  {warehouse.is_active ? 'Active' : 'Inactive'}
                </Badge>
              </TableCell>
              <TableCell className="text-right">
                <div className="flex justify-end gap-2">
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => setEditWarehouse(warehouse)}
                  >
                    <Edit className="h-4 w-4" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => handleDelete(warehouse.id)}
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {editWarehouse && (
        <WarehouseFormModal
          open={!!editWarehouse}
          onClose={() => setEditWarehouse(null)}
          warehouse={editWarehouse}
        />
      )}
    </>
  );
}
```

### Virtual Warehouse Table Component

```typescript
// src/components/tables/virtual-warehouse-table.tsx

'use client';

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { useVirtualWarehouses } from '@/hooks/use-warehouse';
import { WAREHOUSE_TYPE_LABELS } from '@/constants/warehouse';

export function VirtualWarehouseTable() {
  const { data: warehouses, isLoading } = useVirtualWarehouses();

  if (isLoading) return <div>Loading...</div>;

  return (
    <div className="space-y-4">
      <div className="text-sm text-muted-foreground">
        Virtual warehouses are system-defined inventory categories and cannot be modified.
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Name</TableHead>
            <TableHead>Type</TableHead>
            <TableHead>Description</TableHead>
            <TableHead>Products</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {warehouses?.map((warehouse) => (
            <TableRow key={warehouse.id}>
              <TableCell className="font-medium">{warehouse.name}</TableCell>
              <TableCell>
                <Badge variant="outline">
                  {WAREHOUSE_TYPE_LABELS[warehouse.warehouse_type]}
                </Badge>
              </TableCell>
              <TableCell className="text-muted-foreground">
                {warehouse.description}
              </TableCell>
              <TableCell>{warehouse.product_count || 0}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```

### Warehouse Form Modal

```typescript
// src/components/modals/warehouse-form-modal.tsx

'use client';

import { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { useWarehouseCreate, useWarehouseUpdate } from '@/hooks/use-warehouse';
import { toast } from 'sonner';
import type { PhysicalWarehouse } from '@/types/warehouse';

interface WarehouseFormModalProps {
  open: boolean;
  onClose: () => void;
  warehouse?: PhysicalWarehouse;
}

export function WarehouseFormModal({
  open,
  onClose,
  warehouse
}: WarehouseFormModalProps) {
  const [name, setName] = useState('');
  const [location, setLocation] = useState('');
  const [isActive, setIsActive] = useState(true);

  const createWarehouse = useWarehouseCreate();
  const updateWarehouse = useWarehouseUpdate();

  useEffect(() => {
    if (warehouse) {
      setName(warehouse.name);
      setLocation(warehouse.location);
      setIsActive(warehouse.is_active);
    } else {
      setName('');
      setLocation('');
      setIsActive(true);
    }
  }, [warehouse, open]);

  const handleSubmit = async () => {
    try {
      if (warehouse) {
        await updateWarehouse.mutateAsync({
          id: warehouse.id,
          data: { name, location, is_active: isActive }
        });
        toast.success('Warehouse updated successfully');
      } else {
        await createWarehouse.mutateAsync({
          name,
          location,
          is_active: isActive
        });
        toast.success('Warehouse created successfully');
      }
      onClose();
    } catch (error) {
      toast.error(error.message || 'Failed to save warehouse');
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            {warehouse ? 'Edit Physical Warehouse' : 'Create Physical Warehouse'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label htmlFor="name">Warehouse Name</Label>
            <Input
              id="name"
              placeholder="Main Warehouse"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
            />
          </div>

          <div>
            <Label htmlFor="location">Location</Label>
            <Input
              id="location"
              placeholder="Building A, Floor 2, Room 203"
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              required
            />
          </div>

          <div className="flex items-center justify-between">
            <div className="space-y-0.5">
              <Label htmlFor="is-active">Active</Label>
              <p className="text-sm text-muted-foreground">
                Inactive warehouses cannot receive new products
              </p>
            </div>
            <Switch
              id="is-active"
              checked={isActive}
              onCheckedChange={setIsActive}
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button
            onClick={handleSubmit}
            disabled={name.length < 3 || location.length < 5}
          >
            {warehouse ? 'Update' : 'Create'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### RLS Policies

```sql
-- Physical warehouses: Admin/Manager can manage, all staff can read
CREATE POLICY "physical_warehouses_read" ON public.physical_warehouses
  FOR SELECT
  USING (
    auth.check_role('admin') OR
    auth.check_role('manager') OR
    auth.check_role('technician') OR
    auth.check_role('reception')
  );

CREATE POLICY "physical_warehouses_write" ON public.physical_warehouses
  FOR INSERT
  USING (auth.check_role('admin') OR auth.check_role('manager'));

CREATE POLICY "physical_warehouses_update" ON public.physical_warehouses
  FOR UPDATE
  USING (auth.check_role('admin') OR auth.check_role('manager'));

-- Virtual warehouses: All staff can read
CREATE POLICY "virtual_warehouses_read" ON public.virtual_warehouses
  FOR SELECT
  USING (
    auth.check_role('admin') OR
    auth.check_role('manager') OR
    auth.check_role('technician') OR
    auth.check_role('reception')
  );
```

### Testing

**Testing Standards:**
- Follow `docs/architecture/09-testing-strategy.md` when tests are implemented
- Manual testing required for this story

**This Story Testing:**
- **Manual CRUD testing** of physical warehouses
- **Manual verification** of virtual warehouse seeding
- **Manual verification** of delete validation
- **Manual verification** of IV1-IV4

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

---

## QA Results

*This section will be populated by the QA agent after implementation review*
