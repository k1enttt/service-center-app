# Story 1.9: Warehouse Stock Levels and Low Stock Alerts

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.09
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.8 (Serial Verification and Stock Movements)

---

## Story

**As a** warehouse manager,
**I want** to monitor stock levels by product and warehouse with automatic low stock alerts,
**so that** I can proactively reorder warranty stock before running out.

---

## Acceptance Criteria

1. Create database view `v_warehouse_stock_levels` aggregating products by product_id, virtual_warehouse_id
2. Table `product_stock_thresholds` already created by Story 1.1
3. Create tRPC procedures:
   - `inventory.getStockLevels` - Get aggregated stock counts
   - `inventory.setThreshold` - Set low stock threshold for product
   - `inventory.getLowStockAlerts` - Get products below threshold
4. Stock level view shows: product name, warehouse, current count, threshold, status (ok/low/critical)
5. Threshold configuration: per product + virtual warehouse combination
6. Low stock status: warning (at threshold), critical (below 50% of threshold)
7. Build stock levels dashboard at `/dashboard/inventory/stock-levels`
8. Real-time stock count updates when movements recorded
9. Low stock alerts displayed prominently in dashboard
10. Export stock report to CSV

---

## Integration Verification

- **IV1**: Stock levels view does not affect existing product queries
- **IV2**: Threshold configuration does not interfere with product movements
- **IV3**: Stock level calculations remain accurate during high-volume movements
- **IV4**: Dashboard performance acceptable with 1000+ products (<2s load time)

---

## Tasks / Subtasks

### Database Tasks

- [ ] Create stock levels view (AC: 1)
  - [ ] Create `v_warehouse_stock_levels` view
  - [ ] Aggregate physical_products by product_id + virtual_warehouse_id
  - [ ] Calculate count, include product details, warehouse details
  - [ ] Join with product_stock_thresholds
  - [ ] Add index on product_id, virtual_warehouse_id for performance

- [ ] Add threshold defaults (AC: 5)
  - [ ] Create migration to seed default thresholds
  - [ ] Default threshold = 5 for warranty_stock warehouse
  - [ ] Default threshold = 10 for rma_staging warehouse
  - [ ] Thresholds for other warehouses optional

### Backend Tasks

- [ ] Create stock reporting procedures (AC: 3)
  - [ ] Implement `inventory.getStockLevels` with filters
  - [ ] Implement `inventory.setThreshold` procedure
  - [ ] Implement `inventory.getLowStockAlerts` procedure
  - [ ] Add tRPC procedures to inventory router

- [ ] Implement stock status calculation (AC: 6)
  - [ ] Calculate status based on current count vs threshold
  - [ ] ok: count > threshold
  - [ ] warning: count <= threshold && count >= threshold * 0.5
  - [ ] critical: count < threshold * 0.5
  - [ ] Return status with stock level data

- [ ] Add CSV export (AC: 10)
  - [ ] Create `inventory.exportStockReport` procedure
  - [ ] Generate CSV with stock data
  - [ ] Include columns: product name, SKU, warehouse, current stock, threshold, status
  - [ ] Return download URL or CSV string

### Frontend Tasks

- [ ] Create stock level type definitions
  - [ ] Extend `src/types/warehouse.ts`
  - [ ] StockLevel interface
  - [ ] StockStatus enum (ok, warning, critical)
  - [ ] StockThreshold interface

- [ ] Create stock level hooks
  - [ ] Extend `src/hooks/use-warehouse.ts`
  - [ ] `useStockLevels()` hook with filters
  - [ ] `useSetThreshold()` mutation hook
  - [ ] `useLowStockAlerts()` hook
  - [ ] `useExportStockReport()` hook

- [ ] Build stock levels dashboard (AC: 7, 9)
  - [ ] Create `/dashboard/inventory/stock-levels` route
  - [ ] Create `StockLevelsTable` component in `src/components/tables/`
  - [ ] Show: product name, warehouse, current count, threshold, status
  - [ ] Color-coded status indicators
  - [ ] Low stock alert banner at top
  - [ ] Filters: warehouse, status, product category

- [ ] Create threshold configuration UI (AC: 5)
  - [ ] Create `SetThresholdModal` component in `src/components/modals/`
  - [ ] Product + warehouse selector
  - [ ] Threshold input (number)
  - [ ] Preview: current stock, proposed threshold, resulting status

- [ ] Build low stock alerts component (AC: 9)
  - [ ] Create `LowStockAlerts` component in `src/components/shared/`
  - [ ] Display critical alerts prominently (red badge)
  - [ ] Display warnings (yellow badge)
  - [ ] Click to navigate to product details
  - [ ] Dismiss functionality (mark as acknowledged)

- [ ] Implement CSV export button (AC: 10)
  - [ ] Add "Export CSV" button to stock levels page
  - [ ] Trigger download of stock report
  - [ ] Show loading state during export

- [ ] Create stock status indicators
  - [ ] Create `StockStatusBadge` component in `src/components/shared/`
  - [ ] Color coding: ok (green), warning (yellow), critical (red)
  - [ ] Show count and threshold

### Integration & Testing Tasks

- [ ] Test existing product queries (IV1)
  - [ ] Run existing product list queries
  - [ ] Verify no performance degradation
  - [ ] Verify correct results

- [ ] Test product movements (IV2)
  - [ ] Set thresholds
  - [ ] Record product movements
  - [ ] Verify movements work normally

- [ ] Test calculation accuracy (IV3)
  - [ ] Create high volume of movements
  - [ ] Verify stock counts remain accurate
  - [ ] Verify no race conditions

- [ ] Test dashboard performance (IV4)
  - [ ] Load dashboard with 1000+ products
  - [ ] Measure load time
  - [ ] Verify <2s load time requirement

---

## Dev Notes

### Stock Levels Database View

```sql
CREATE OR REPLACE VIEW v_warehouse_stock_levels AS
SELECT
  p.id AS product_id,
  p.name AS product_name,
  p.sku,
  vw.id AS virtual_warehouse_id,
  vw.name AS warehouse_name,
  vw.warehouse_type,
  COUNT(pp.id) AS current_stock,
  COALESCE(pst.threshold, 0) AS threshold,
  CASE
    WHEN COUNT(pp.id) > COALESCE(pst.threshold, 0) THEN 'ok'
    WHEN COUNT(pp.id) <= COALESCE(pst.threshold, 0) AND COUNT(pp.id) >= COALESCE(pst.threshold, 0) * 0.5 THEN 'warning'
    ELSE 'critical'
  END AS stock_status
FROM products p
CROSS JOIN virtual_warehouses vw
LEFT JOIN physical_products pp ON pp.product_id = p.id AND pp.virtual_warehouse_id = vw.id
LEFT JOIN product_stock_thresholds pst ON pst.product_id = p.id AND pst.virtual_warehouse_id = vw.id
GROUP BY p.id, p.name, p.sku, vw.id, vw.name, vw.warehouse_type, pst.threshold
HAVING COUNT(pp.id) > 0 OR COALESCE(pst.threshold, 0) > 0;

-- Add comment
COMMENT ON VIEW v_warehouse_stock_levels IS
  'Aggregated stock levels by product and virtual warehouse with threshold status';
```

### Seed Default Thresholds

```sql
-- Seed default thresholds for warranty stock
INSERT INTO product_stock_thresholds (product_id, virtual_warehouse_id, threshold)
SELECT
  p.id,
  vw.id,
  5 AS threshold
FROM products p
CROSS JOIN virtual_warehouses vw
WHERE vw.warehouse_type = 'warranty_stock'
ON CONFLICT (product_id, virtual_warehouse_id) DO NOTHING;

-- Seed default thresholds for RMA staging
INSERT INTO product_stock_thresholds (product_id, virtual_warehouse_id, threshold)
SELECT
  p.id,
  vw.id,
  10 AS threshold
FROM products p
CROSS JOIN virtual_warehouses vw
WHERE vw.warehouse_type = 'rma_staging'
ON CONFLICT (product_id, virtual_warehouse_id) DO NOTHING;
```

### tRPC Stock Procedures

```typescript
// src/server/routers/inventory.ts (extend existing)

getStockLevels: publicProcedure
  .input(z.object({
    virtual_warehouse_id: z.string().uuid().optional(),
    stock_status: z.enum(['ok', 'warning', 'critical']).optional(),
    product_category_id: z.string().uuid().optional()
  }))
  .query(async ({ ctx }) => {
    if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
      throw new TRPCError({ code: 'FORBIDDEN' });
    }

    let query = ctx.supabaseAdmin
      .from('v_warehouse_stock_levels')
      .select('*');

    // Apply filters (if supported by view)
    // Note: filtering on views may require additional logic

    const { data, error } = await query.order('stock_status', { ascending: false });

    if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

    return data || [];
  }),

setThreshold: publicProcedure
  .input(z.object({
    product_id: z.string().uuid(),
    virtual_warehouse_id: z.string().uuid(),
    threshold: z.number().min(0).max(1000)
  }))
  .mutation(async ({ ctx, input }) => {
    if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
      throw new TRPCError({ code: 'FORBIDDEN' });
    }

    const { data, error } = await ctx.supabaseAdmin
      .from('product_stock_thresholds')
      .upsert({
        product_id: input.product_id,
        virtual_warehouse_id: input.virtual_warehouse_id,
        threshold: input.threshold,
        updated_by_id: ctx.user.id
      })
      .select()
      .single();

    if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

    return data;
  }),

getLowStockAlerts: publicProcedure
  .query(async ({ ctx }) => {
    if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
      throw new TRPCError({ code: 'FORBIDDEN' });
    }

    const { data, error } = await ctx.supabaseAdmin
      .from('v_warehouse_stock_levels')
      .select('*')
      .in('stock_status', ['warning', 'critical'])
      .order('stock_status', { ascending: false })
      .order('current_stock', { ascending: true });

    if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

    return data || [];
  }),

exportStockReport: publicProcedure
  .query(async ({ ctx }) => {
    if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
      throw new TRPCError({ code: 'FORBIDDEN' });
    }

    const { data, error } = await ctx.supabaseAdmin
      .from('v_warehouse_stock_levels')
      .select('*')
      .order('product_name');

    if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

    // Generate CSV
    const headers = ['Product Name', 'SKU', 'Warehouse', 'Current Stock', 'Threshold', 'Status'];
    const rows = data.map(item => [
      item.product_name,
      item.sku,
      item.warehouse_name,
      item.current_stock,
      item.threshold,
      item.stock_status
    ]);

    const csv = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    return { csv, filename: `stock-report-${new Date().toISOString()}.csv` };
  })
```

### Stock Levels Dashboard Page

```typescript
// app/(auth)/dashboard/inventory/stock-levels/page.tsx

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { StockLevelsTable } from '@/components/tables/stock-levels-table';
import { LowStockAlerts } from '@/components/shared/low-stock-alerts';
import { useStockLevels, useExportStockReport } from '@/hooks/use-warehouse';
import { Download } from 'lucide-react';
import { toast } from 'sonner';

export default function StockLevelsPage() {
  const { data: stockLevels, isLoading } = useStockLevels();
  const { mutate: exportReport, isPending: isExporting } = useExportStockReport();

  const handleExport = () => {
    exportReport(undefined, {
      onSuccess: (result) => {
        // Create blob and trigger download
        const blob = new Blob([result.csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        toast.success('Stock report exported successfully');
      },
      onError: () => {
        toast.error('Failed to export stock report');
      }
    });
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Stock Levels</h1>
          <p className="text-muted-foreground">
            Monitor inventory levels and manage stock thresholds
          </p>
        </div>
        <Button onClick={handleExport} disabled={isExporting}>
          <Download className="mr-2 h-4 w-4" />
          Export CSV
        </Button>
      </div>

      <LowStockAlerts />

      <StockLevelsTable data={stockLevels} isLoading={isLoading} />
    </div>
  );
}
```

### Low Stock Alerts Component

```typescript
// src/components/shared/low-stock-alerts.tsx

'use client';

import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { useLowStockAlerts } from '@/hooks/use-warehouse';
import { AlertTriangle, AlertCircle } from 'lucide-react';

export function LowStockAlerts() {
  const { data: alerts, isLoading } = useLowStockAlerts();

  if (isLoading || !alerts || alerts.length === 0) return null;

  const critical = alerts.filter(a => a.stock_status === 'critical');
  const warnings = alerts.filter(a => a.stock_status === 'warning');

  return (
    <div className="space-y-3">
      {critical.length > 0 && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Critical Stock Levels</AlertTitle>
          <AlertDescription>
            <div className="mt-2 space-y-1">
              {critical.slice(0, 3).map(item => (
                <div key={`${item.product_id}-${item.virtual_warehouse_id}`} className="flex items-center gap-2">
                  <Badge variant="destructive">{item.current_stock}</Badge>
                  <span className="text-sm">
                    {item.product_name} in {item.warehouse_name} (Threshold: {item.threshold})
                  </span>
                </div>
              ))}
              {critical.length > 3 && (
                <p className="text-sm text-muted-foreground">
                  + {critical.length - 3} more critical items
                </p>
              )}
            </div>
          </AlertDescription>
        </Alert>
      )}

      {warnings.length > 0 && (
        <Alert>
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>Low Stock Warnings</AlertTitle>
          <AlertDescription>
            <p className="text-sm">
              {warnings.length} product(s) approaching low stock threshold
            </p>
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
}
```

### Stock Levels Table Component

```typescript
// src/components/tables/stock-levels-table.tsx

'use client';

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Button } from '@/components/ui/button';
import { StockStatusBadge } from '@/components/shared/stock-status-badge';
import { Settings } from 'lucide-react';
import { useState } from 'react';
import { SetThresholdModal } from '@/components/modals/set-threshold-modal';

interface StockLevelsTableProps {
  data: any[];
  isLoading: boolean;
}

export function StockLevelsTable({ data, isLoading }: StockLevelsTableProps) {
  const [selectedItem, setSelectedItem] = useState<any>(null);

  if (isLoading) return <div>Loading...</div>;

  return (
    <>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Product</TableHead>
            <TableHead>SKU</TableHead>
            <TableHead>Warehouse</TableHead>
            <TableHead className="text-right">Current Stock</TableHead>
            <TableHead className="text-right">Threshold</TableHead>
            <TableHead>Status</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {data?.map((item) => (
            <TableRow key={`${item.product_id}-${item.virtual_warehouse_id}`}>
              <TableCell className="font-medium">{item.product_name}</TableCell>
              <TableCell>{item.sku}</TableCell>
              <TableCell>{item.warehouse_name}</TableCell>
              <TableCell className="text-right">{item.current_stock}</TableCell>
              <TableCell className="text-right">{item.threshold}</TableCell>
              <TableCell>
                <StockStatusBadge
                  status={item.stock_status}
                  currentStock={item.current_stock}
                  threshold={item.threshold}
                />
              </TableCell>
              <TableCell className="text-right">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setSelectedItem(item)}
                >
                  <Settings className="h-4 w-4" />
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {selectedItem && (
        <SetThresholdModal
          open={!!selectedItem}
          onClose={() => setSelectedItem(null)}
          productId={selectedItem.product_id}
          warehouseId={selectedItem.virtual_warehouse_id}
          currentThreshold={selectedItem.threshold}
          currentStock={selectedItem.current_stock}
        />
      )}
    </>
  );
}
```

### Stock Status Badge Component

```typescript
// src/components/shared/stock-status-badge.tsx

import { Badge } from '@/components/ui/badge';

interface StockStatusBadgeProps {
  status: 'ok' | 'warning' | 'critical';
  currentStock?: number;
  threshold?: number;
}

const statusConfig = {
  ok: { label: 'OK', variant: 'success' as const },
  warning: { label: 'Low Stock', variant: 'warning' as const },
  critical: { label: 'Critical', variant: 'destructive' as const }
};

export function StockStatusBadge({ status, currentStock, threshold }: StockStatusBadgeProps) {
  const config = statusConfig[status];

  return (
    <div className="flex items-center gap-2">
      <Badge variant={config.variant}>{config.label}</Badge>
      {currentStock !== undefined && threshold !== undefined && (
        <span className="text-xs text-muted-foreground">
          {currentStock}/{threshold}
        </span>
      )}
    </div>
  );
}
```

### Set Threshold Modal

```typescript
// src/components/modals/set-threshold-modal.tsx

'use client';

import { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useSetThreshold } from '@/hooks/use-warehouse';
import { toast } from 'sonner';

interface SetThresholdModalProps {
  open: boolean;
  onClose: () => void;
  productId: string;
  warehouseId: string;
  currentThreshold: number;
  currentStock: number;
}

export function SetThresholdModal({
  open,
  onClose,
  productId,
  warehouseId,
  currentThreshold,
  currentStock
}: SetThresholdModalProps) {
  const [threshold, setThreshold] = useState(currentThreshold);
  const setThresholdMutation = useSetThreshold();

  useEffect(() => {
    setThreshold(currentThreshold);
  }, [currentThreshold, open]);

  const handleSubmit = async () => {
    try {
      await setThresholdMutation.mutateAsync({
        product_id: productId,
        virtual_warehouse_id: warehouseId,
        threshold
      });
      toast.success('Threshold updated successfully');
      onClose();
    } catch (error) {
      toast.error(error.message || 'Failed to update threshold');
    }
  };

  // Calculate resulting status
  let resultingStatus: 'ok' | 'warning' | 'critical' = 'ok';
  if (currentStock <= threshold && currentStock >= threshold * 0.5) {
    resultingStatus = 'warning';
  } else if (currentStock < threshold * 0.5) {
    resultingStatus = 'critical';
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Set Low Stock Threshold</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label htmlFor="threshold">Threshold</Label>
            <Input
              type="number"
              id="threshold"
              min={0}
              max={1000}
              value={threshold}
              onChange={(e) => setThreshold(Number(e.target.value))}
            />
            <p className="text-sm text-muted-foreground mt-1">
              Alert when stock falls to or below this number
            </p>
          </div>

          <div className="border rounded-lg p-4 space-y-2">
            <h4 className="font-medium">Preview</h4>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div>
                <span className="text-muted-foreground">Current Stock:</span> {currentStock}
              </div>
              <div>
                <span className="text-muted-foreground">Threshold:</span> {threshold}
              </div>
              <div className="col-span-2">
                <span className="text-muted-foreground">Resulting Status:</span>{' '}
                <Badge variant={resultingStatus === 'ok' ? 'success' : resultingStatus === 'warning' ? 'warning' : 'destructive'}>
                  {resultingStatus.toUpperCase()}
                </Badge>
              </div>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit} disabled={threshold < 0}>
            Save Threshold
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### Testing

**Testing Standards:**
- Follow `docs/architecture/09-testing-strategy.md` when tests are implemented
- Manual testing required for this story

**This Story Testing:**
- **Manual verification** of stock level view accuracy
- **Manual threshold configuration** testing
- **Manual verification** of low stock alerts
- **Manual CSV export** testing
- **Manual verification** of IV1-IV4

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

---

## QA Results

*This section will be populated by the QA agent after implementation review*
