# Story 1.4: Task Execution UI for Technicians

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.04
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.3 (Automatic Task Generation)

---

## Story

**As a** technician,
**I want** to view my assigned tasks and update their status as I work,
**so that** managers can track progress at granular level.

---

## Acceptance Criteria

1. Create tRPC procedures:
   - `workflow.myTasks` - Get tasks assigned to current user
   - `workflow.updateTaskStatus` - Update task status (pending → in_progress → completed)
   - `workflow.addTaskNotes` - Add notes to task
   - `workflow.completeTask` - Mark complete with required completion_notes
2. Build `/dashboard/my-tasks` page showing all assigned tasks grouped by ticket
3. Integrate task list into ticket detail page (`/dashboard/tickets/[id]`)
4. Task card shows: name, status, estimated duration, notes field
5. Quick action buttons: "Start Task", "Mark Complete", "Block Task"
6. Task completion modal requires completion_notes (validation)
7. Visual indicators: status badges, progress bar showing X of Y tasks done
8. Real-time updates via TanStack Query (30-second polling)

---

## Integration Verification

- **IV1**: Existing ticket detail page displays tasks without breaking current layout
- **IV2**: Marking task as complete does not interfere with manual ticket status changes
- **IV3**: Task notes are separate from existing ticket comments (both visible in timeline)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] Create tRPC workflow procedures (AC: 1)
  - [ ] `workflow.myTasks` - Query tasks WHERE assigned_to_id = ctx.user.id
  - [ ] `workflow.updateTaskStatus` - Validate status transitions, update task
  - [ ] `workflow.addTaskNotes` - Insert into task_history table
  - [ ] `workflow.completeTask` - Require completion_notes, set status = 'completed', timestamp

### Frontend Tasks

- [ ] Create My Tasks page (AC: 2)
  - [ ] Create `/dashboard/my-tasks/page.tsx`
  - [ ] Group tasks by ticket_id
  - [ ] Show ticket number, customer name, task count
  - [ ] Use TaskProgressTable component from `src/components/tables/`

- [ ] Create task execution components (AC: 3, 4, 5)
  - [ ] Create `TaskExecutionCard` in `src/components/shared/`
  - [ ] Show task name, status badge, sequence number, estimated duration
  - [ ] Add notes textarea
  - [ ] Quick action buttons: Start (pending→in_progress), Complete (opens modal), Block

- [ ] Create task completion modal (AC: 6)
  - [ ] Create `TaskCompletionModal` in `src/components/modals/`
  - [ ] Require completion_notes field
  - [ ] Validate notes not empty
  - [ ] On submit, call `workflow.completeTask`

- [ ] Integrate into ticket detail (AC: 3, 7)
  - [ ] Update existing TaskListAccordion to be interactive (not read-only)
  - [ ] Show progress bar: "3 of 8 tasks completed"
  - [ ] Enable task actions for assigned technician

- [ ] Implement polling (AC: 8)
  - [ ] Use TanStack Query refetchInterval: 30000
  - [ ] Auto-refresh task status

---

## Dev Notes

### tRPC Procedures

```typescript
// src/server/routers/workflow.ts (extend existing router)
workflow: router({
  myTasks: publicProcedure.query(async ({ ctx }) => {
    if (!ctx.user) throw new TRPCError({ code: 'UNAUTHORIZED' });

    return await ctx.supabaseAdmin
      .from('service_ticket_tasks')
      .select(`
        *,
        task_type:task_types(*),
        ticket:service_tickets(ticket_number, customer:customers(name))
      `)
      .eq('assigned_to_id', ctx.user.id)
      .in('status', ['pending', 'in_progress', 'blocked'])
      .order('ticket_id', { ascending: true })
      .order('sequence_order', { ascending: true });
  }),

  updateTaskStatus: publicProcedure
    .input(z.object({ taskId: z.string(), status: z.enum(['pending', 'in_progress', 'blocked']) }))
    .mutation(async ({ ctx, input }) => {
      // Validate user is assigned to this task
      // Update status and timestamp
    }),

  completeTask: publicProcedure
    .input(z.object({ taskId: z.string(), completionNotes: z.string().min(10) }))
    .mutation(async ({ ctx, input }) => {
      // Validate assigned to current user
      // Set status = 'completed', completed_at = now()
      // Insert completion_notes into task_history
      // Log to service_ticket_comments for audit trail
    })
})
```

### My Tasks Page

```typescript
// app/(auth)/dashboard/my-tasks/page.tsx
'use client';

export default function MyTasksPage() {
  const { data: tasks } = trpc.workflow.myTasks.useQuery(undefined, {
    refetchInterval: 30000 // 30 seconds
  });

  const groupedByTicket = groupBy(tasks, 'ticket_id');

  return (
    <div className="space-y-6">
      <h1>My Tasks</h1>
      {Object.entries(groupedByTicket).map(([ticketId, ticketTasks]) => (
        <Card key={ticketId}>
          <CardHeader>
            <CardTitle>
              {ticketTasks[0].ticket.ticket_number} - {ticketTasks[0].ticket.customer.name}
            </CardTitle>
          </CardHeader>
          <CardContent>
            {ticketTasks.map(task => (
              <TaskExecutionCard key={task.id} task={task} />
            ))}
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

### Task Execution Card

```typescript
// src/components/shared/task-execution-card.tsx
export function TaskExecutionCard({ task }: { task: Task }) {
  const updateStatus = trpc.workflow.updateTaskStatus.useMutation();
  const [showCompletionModal, setShowCompletionModal] = useState(false);

  return (
    <div className="border rounded-lg p-4 space-y-3">
      <div className="flex items-center justify-between">
        <div>
          <h3>{task.task_type.name}</h3>
          <TaskStatusBadge status={task.status} />
        </div>
        <div className="flex gap-2">
          {task.status === 'pending' && (
            <Button onClick={() => updateStatus.mutate({ taskId: task.id, status: 'in_progress' })}>
              Start Task
            </Button>
          )}
          {task.status === 'in_progress' && (
            <>
              <Button onClick={() => setShowCompletionModal(true)}>Mark Complete</Button>
              <Button variant="destructive" onClick={() => updateStatus.mutate({ taskId: task.id, status: 'blocked' })}>
                Block
              </Button>
            </>
          )}
        </div>
      </div>

      <TaskCompletionModal
        open={showCompletionModal}
        onClose={() => setShowCompletionModal(false)}
        taskId={task.id}
      />
    </div>
  );
}
```

### Testing

**Manual Testing:**
- Assign task to technician
- Log in as technician
- View My Tasks page
- Start task, add notes, mark complete
- Verify status updates
- Verify completion modal validation

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Dev Agent Record

*To be populated during implementation*

---

## QA Results

*To be populated after QA review*
