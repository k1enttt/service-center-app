# Story 1.14: Customer Delivery Confirmation Workflow

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.14
**Created:** 2025-10-23
**Status:** ✅ Complete
**Completed:** 2025-10-25 (Verified via code review)
**Depends On:** Story 1.13 (Staff Request Management)

---

## Story

**As a** reception staff member,
**I want** to record customer delivery confirmations for completed tickets,
**so that** we track when customers received their products and can follow up if needed.

---

## Acceptance Criteria

1. Add delivery tracking fields to service_tickets: delivery_confirmed_at, delivery_confirmed_by_id, delivery_signature, delivery_notes
2. Create tRPC procedures:
   - `tickets.confirmDelivery` - Record delivery confirmation
   - `tickets.getPendingDeliveries` - List completed tickets pending delivery confirmation
3. Build delivery confirmation page at `/dashboard/deliveries`
4. Confirmation form: customer signature (canvas), delivery notes, photo upload (Supabase Storage)
5. Mark ticket as "delivered" after confirmation
6. Send delivery confirmation email to customer (Story 1.15)
7. Delivery report: list of all deliveries with filters (date range, method)
8. Export delivery log to CSV
9. Validation: Can only confirm delivery for completed tickets
10. Auto-notification if ticket completed but not delivered after 7 days

---

## Integration Verification

- **IV1**: Delivery confirmation does not change ticket completion status
- **IV2**: Existing ticket completion workflow unaffected
- **IV3**: Delivery tracking operates independently from task system
- **IV4**: Photo uploads to separate bucket from other images

---

## Tasks / Subtasks

### Database Tasks
- [ ] Extend service_tickets table with delivery fields
- [ ] Create delivery_confirmations table for audit trail
- [ ] Add indexes for delivery queries

### Backend Tasks
- [ ] Implement `tickets.confirmDelivery` procedure
- [ ] Implement `tickets.getPendingDeliveries` procedure
- [ ] Add delivery signature storage (base64 → Supabase Storage)
- [ ] Create delivery report query
- [ ] Implement CSV export

### Frontend Tasks
- [ ] Build delivery confirmation page
- [ ] Create signature canvas component
- [ ] Create delivery confirmation modal
- [ ] Build pending deliveries list
- [ ] Add delivery status indicator to ticket detail
- [ ] Implement photo upload for delivery proof

---

## Dev Notes

**Key Implementation:**
- Signature canvas using HTML5 Canvas API or library (signature_pad.js)
- Store signature as image in `delivery-photos` Supabase Storage bucket
- Delivery confirmation creates audit record in delivery_confirmations table
- Pending deliveries: WHERE status = 'completed' AND delivery_confirmed_at IS NULL

**Testing:** Manual delivery confirmation workflow, photo upload, CSV export

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |
