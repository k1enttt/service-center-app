# Story 1.2: Task Template Management (Admin)

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.02
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.1 (Foundation Setup)

---

## Story

**As an** administrator,
**I want** to create and manage task templates for different service types,
**so that** technicians follow standardized workflows for each product/service combination.

---

## Acceptance Criteria

1. Seed database with 15+ default task types (Initial Inspection, Run Diagnostic Tests, etc.)
2. Create tRPC `workflow` router with procedures:
   - `taskType.list` - Get all task types
   - `taskType.create` - Create custom task type
   - `template.create` - Create task template
   - `template.update` - Update template (creates new version)
   - `template.list` - List templates by product type
   - `template.assignToProduct` - Link template to product type + service type
3. Implement template versioning (editing creates new version, marks old inactive)
4. Build admin UI at `/dashboard/workflows/templates`
5. Drag-and-drop task ordering in template editor
6. Preview template before activation
7. Validation: Cannot delete template if in use by active tickets

---

## Integration Verification

- **IV1**: Creating templates does not affect existing ticket creation workflow
- **IV2**: Existing tickets without templates continue to function normally
- **IV3**: Admin dashboard navigation includes new Workflows section

---

## Tasks / Subtasks

### Backend Tasks

- [ ] Seed default task types (AC: 1)
  - [ ] Create seed data file with 15+ task types
  - [ ] Categories: Intake (Initial Inspection, Customer Interview), Diagnosis (Run Diagnostic Tests, Identify Issue), Repair (Replace Component, Repair Component), QA (Quality Check, Functional Test), Closing (Final Inspection, Customer Notification)
  - [ ] Create migration or seed script to populate `task_types` table

- [ ] Create tRPC workflow router (AC: 2)
  - [ ] Create `src/server/routers/workflow.ts`
  - [ ] Implement `taskType.list` procedure with role check (Admin/Manager)
  - [ ] Implement `taskType.create` procedure with validation
  - [ ] Implement `template.create` procedure
  - [ ] Implement `template.update` procedure (creates new version, marks old inactive)
  - [ ] Implement `template.list` procedure with filters (product_type, service_type)
  - [ ] Implement `template.assignToProduct` procedure
  - [ ] Add workflow router to `src/server/routers/_app.ts`

- [ ] Implement template versioning (AC: 3)
  - [ ] On `template.update`, set current template `is_active = false`
  - [ ] Create new template record with incremented version number
  - [ ] Copy task associations to new template version
  - [ ] Maintain `previous_version_id` reference

- [ ] Add validation logic (AC: 7)
  - [ ] Check if template is referenced by active tickets before delete
  - [ ] Return error if deletion would break active tickets
  - [ ] Allow soft delete (mark inactive) as alternative

### Frontend Tasks

- [ ] Create type definitions (uses Story 1.1 structure)
  - [ ] Define types in `src/types/workflow.ts`
  - [ ] TaskType interface
  - [ ] TaskTemplate interface
  - [ ] TemplateTask interface (join table)

- [ ] Create workflow custom hooks (uses Story 1.1 structure)
  - [ ] Implement `src/hooks/use-workflow.ts`
  - [ ] `useTaskTypes()` hook
  - [ ] `useTemplates()` hook
  - [ ] `useTemplateCreate()` mutation hook
  - [ ] `useTemplateUpdate()` mutation hook

- [ ] Build template management UI (AC: 4)
  - [ ] Create `/dashboard/workflows/templates` route
  - [ ] Create `TemplateListTable` component in `src/components/tables/`
  - [ ] Show template name, product type, service type, version, status (active/inactive)
  - [ ] Actions: Edit, View, Activate/Deactivate, Delete

- [ ] Build template editor modal (AC: 5, 6)
  - [ ] Create `TemplateEditorModal` component in `src/components/modals/`
  - [ ] Multi-step modal: Details → Tasks → Preview → Confirm
  - [ ] Step 1: Template name, product type, service type, description
  - [ ] Step 2: Drag-and-drop task ordering (use React DnD or @dnd-kit)
  - [ ] Step 3: Preview template with task sequence and estimated duration
  - [ ] Step 4: Confirm and save

- [ ] Implement drag-and-drop ordering (AC: 5)
  - [ ] Install @dnd-kit/core and @dnd-kit/sortable
  - [ ] Create DraggableTaskList component
  - [ ] Allow reordering tasks
  - [ ] Update sequence_order on drop

- [ ] Update navigation (IV3)
  - [ ] Add "Workflows" section to sidebar navigation
  - [ ] Add "Templates" submenu item
  - [ ] Ensure only Admin/Manager can see this menu

### Integration & Testing Tasks

- [ ] Verify existing ticket workflow (IV1, IV2)
  - [ ] Create test tickets without templates
  - [ ] Verify ticket creation succeeds
  - [ ] Verify existing ticket detail view works

- [ ] Test template CRUD operations
  - [ ] Create template
  - [ ] Update template (verify versioning)
  - [ ] List templates
  - [ ] Delete template (with and without active ticket references)

- [ ] Test template assignment
  - [ ] Assign template to product type + service type combination
  - [ ] Verify uniqueness constraint (one template per combination)

---

## Dev Notes

### Default Task Types to Seed

**Intake Category:**
- Initial Inspection
- Customer Interview
- Product Receiving
- Serial Number Verification

**Diagnosis Category:**
- Run Diagnostic Tests
- Identify Root Cause
- Component Testing
- Fault Isolation

**Repair Category:**
- Replace Component
- Repair Component
- Clean/Service
- Software Update

**QA Category:**
- Quality Check
- Functional Test
- Final Inspection

**Closing Category:**
- Customer Notification
- Documentation Update
- Warranty Registration

### Template Versioning Logic

```typescript
// Template Update Flow
async updateTemplate(input) {
  // 1. Fetch current active template
  const currentTemplate = await getActiveTemplate(input.templateId);

  // 2. Mark current as inactive
  await updateTemplate(currentTemplate.id, { is_active: false });

  // 3. Create new version
  const newTemplate = await createTemplate({
    ...input,
    version: currentTemplate.version + 1,
    previous_version_id: currentTemplate.id,
    is_active: true
  });

  // 4. Copy task associations
  await copyTemplateTasks(currentTemplate.id, newTemplate.id);

  return newTemplate;
}
```

### tRPC Router Structure

```typescript
// src/server/routers/workflow.ts
export const workflowRouter = router({
  taskType: router({
    list: publicProcedure.query(async ({ ctx }) => {
      // Check role
      if (!ctx.user || !['admin', 'manager'].includes(ctx.user.role)) {
        throw new TRPCError({ code: 'FORBIDDEN' });
      }
      return await ctx.supabaseAdmin
        .from('task_types')
        .select('*')
        .order('category', { ascending: true });
    }),
    create: publicProcedure
      .input(z.object({ name: z.string(), category: z.string(), ... }))
      .mutation(async ({ ctx, input }) => {
        // Implementation
      })
  }),

  template: router({
    list: publicProcedure.query(...),
    create: publicProcedure.mutation(...),
    update: publicProcedure.mutation(...),
    assignToProduct: publicProcedure.mutation(...)
  })
});
```

### Drag-and-Drop Implementation

Use `@dnd-kit` for React 19 compatibility:

```typescript
import { DndContext, closestCenter } from '@dnd-kit/core';
import { arrayMove, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';

function DraggableTaskList({ tasks, onReorder }) {
  const handleDragEnd = (event) => {
    const { active, over } = event;
    if (active.id !== over.id) {
      const oldIndex = tasks.findIndex(t => t.id === active.id);
      const newIndex = tasks.findIndex(t => t.id === over.id);
      const reordered = arrayMove(tasks, oldIndex, newIndex);
      onReorder(reordered.map((t, idx) => ({ ...t, sequence_order: idx })));
    }
  };

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={tasks} strategy={verticalListSortingStrategy}>
        {tasks.map(task => <SortableTaskItem key={task.id} task={task} />)}
      </SortableContext>
    </DndContext>
  );
}
```

### UI Component Structure

```
src/components/
├── tables/
│   └── template-list-table.tsx
├── modals/
│   └── template-editor-modal.tsx
└── shared/
    ├── draggable-task-list.tsx
    └── template-preview-card.tsx
```

### RLS Policies

Templates should be readable by all staff, editable by Admin/Manager only:

```sql
-- Read access for all staff
CREATE POLICY "task_templates_read" ON public.task_templates
  FOR SELECT
  USING (
    auth.check_role('admin') OR
    auth.check_role('manager') OR
    auth.check_role('technician') OR
    auth.check_role('reception')
  );

-- Write access for Admin/Manager only
CREATE POLICY "task_templates_write" ON public.task_templates
  FOR INSERT
  USING (auth.check_role('admin') OR auth.check_role('manager'));
```

### Navigation Integration

Add to sidebar navigation (Admin/Manager only):

```tsx
{(userRole === 'admin' || userRole === 'manager') && (
  <NavigationSection title="Workflows">
    <NavigationItem href="/dashboard/workflows/templates" icon={TemplateIcon}>
      Templates
    </NavigationItem>
    <NavigationItem href="/dashboard/workflows/task-types" icon={TaskIcon}>
      Task Types
    </NavigationItem>
  </NavigationSection>
)}
```

### Testing

**Testing Standards:**
- Follow `docs/architecture/09-testing-strategy.md` when tests are implemented
- Manual testing required for this story

**This Story Testing:**
- **Manual CRUD testing** of templates
- **Manual verification** of drag-and-drop ordering
- **Manual verification** of template versioning
- **Manual verification** of IV1-IV3

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from PRD | John (PM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

---

## QA Results

*This section will be populated by the QA agent after implementation review*
