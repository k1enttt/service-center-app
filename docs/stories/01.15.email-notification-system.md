# Story 1.15: Email Notification System (6 Key Moments)

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.15
**Created:** 2025-10-23
**Status:** ✅ Complete
**Completed:** 2025-10-25 (Verified via code review)
**Depends On:** Story 1.14 (Delivery Confirmation)

---

## Story

**As a** customer,
**I want** to receive email notifications at key moments in the service process,
**so that** I stay informed without needing to contact the service center.

---

## Acceptance Criteria

1. Use Supabase GoTrue v2.180.0 built-in SMTP for email sending
2. Create 6 email templates (HTML):
   - Service request submitted (with tracking token)
   - Request received by staff
   - Request rejected (with reason)
   - Ticket created / Service started
   - Service completed / Ready for pickup/delivery
   - Delivery confirmed
3. Table `email_notifications` logs all sent emails
4. Create tRPC procedure `notifications.send` (internal use)
5. Trigger emails via database triggers or tRPC post-mutation hooks
6. Email content includes: customer name, tracking token / ticket number, status, next steps
7. Unsubscribe link in all emails
8. Email sending failures logged and retried (3 attempts)
9. Admin page to view email log at `/dashboard/notifications`
10. Rate limiting: max 100 emails per customer per day

---

## Integration Verification

- **IV1**: Email notifications do not block primary operations (async sending)
- **IV2**: Failed emails do not cause transaction rollbacks
- **IV3**: Email log does not impact database performance
- **IV4**: Unsubscribe respects customer preferences

---

## Tasks / Subtasks

### Backend Tasks
- [ ] Configure Supabase SMTP settings
- [ ] Create email_notifications table
- [ ] Create email templates (HTML + plain text fallback)
- [ ] Implement `notifications.send` procedure
- [ ] Add email triggers to relevant mutations
- [ ] Implement retry logic for failures
- [ ] Add rate limiting check

### Frontend Tasks
- [ ] Build email log page
- [ ] Create email preview component
- [ ] Add email preferences to customer profile

---

## Dev Notes

**Email Implementation:**
- Use Supabase built-in auth.users email functions or Edge Functions
- Templates use Handlebars or similar for variable interpolation
- Store templates in database or config files
- Log status: sent, failed, bounced, opened (if tracking enabled)

**6 Email Moments:**
1. Service request submitted → immediate
2. Request received → when staff marks as received
3. Request rejected → when staff rejects
4. Service started → when ticket created from request
5. Service completed → when ticket status = completed
6. Delivery confirmed → when delivery recorded

**Testing:** Manual email trigger testing, template rendering, SMTP configuration

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |
