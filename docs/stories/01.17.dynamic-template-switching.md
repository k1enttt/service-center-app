# Story 1.17: Dynamic Template Switching During Service

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.17
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.3 (Automatic Task Generation)

---

## Story

**As a** technician,
**I want** to switch to a different task template mid-service if diagnosis reveals different issue,
**so that** the workflow adapts to actual service needs.

---

## Acceptance Criteria

1. Create tRPC procedure `workflow.switchTemplate` - Change ticket's task template
2. Template switching preserves completed tasks, adds new tasks from new template
3. Skip duplicate tasks already completed
4. Log template change to ticket_template_changes table (audit trail)
5. UI: "Switch Template" button on ticket detail page (Manager/Technician only)
6. Template selection modal shows: current template, available templates, preview of new tasks
7. Confirmation dialog warns about adding new tasks
8. Validation: Cannot switch if all tasks completed
9. Record reason for template change (required field)
10. Notification to manager when template switched

---

## Integration Verification

- **IV1**: Completed tasks remain completed after switch
- **IV2**: In-progress tasks continue normally
- **IV3**: Template switching does not affect ticket status
- **IV4**: Audit trail captures all template changes

---

## Tasks / Subtasks

### Backend Tasks
- [ ] Implement `workflow.switchTemplate` procedure
- [ ] Merge task logic: preserve completed, add new unique tasks
- [ ] Log to ticket_template_changes table
- [ ] Add validation for template compatibility

### Frontend Tasks
- [ ] Add "Switch Template" button to ticket detail
- [ ] Create template selection modal
- [ ] Show preview of tasks to be added
- [ ] Implement confirmation dialog with reason field

---

## Dev Notes

**Template Switch Logic:**
1. Get current tasks (with completion status)
2. Get tasks from new template
3. Mark old template inactive for this ticket
4. Add new tasks not in current set (by task_type_id)
5. Preserve sequence order from new template
6. Log change with reason

**Testing:** Manual template switching, task preservation, audit trail verification

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |
