# Story 1.12: Service Request Tracking Page

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.12
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.11 (Public Service Request Portal)

---

## Story

**As a** customer,
**I want** to track my service request status using my tracking token,
**so that** I can see the progress of my service without contacting support.

---

## Acceptance Criteria

1. Create public tRPC procedure:
   - `serviceRequest.track` - Get request status by tracking token (public, no auth)
2. Tracking page at `/service-request/track` (public, no auth required)
3. Token input with validation (format: SR-XXXXXXXXXXXX)
4. Display request details: status, product, submission date, estimated completion
5. Status timeline showing: submitted → received → processing → completed
6. Display customer details (masked email/phone for privacy)
7. Show linked ticket number once staff creates ticket
8. Status-specific messages and next steps for customer
9. Real-time status updates (refetch every 30 seconds when page active)
10. Request not found handling with helpful error message
11. Share-friendly URL: `/service-request/track?token=SR-ABC123XYZ789`

---

## Integration Verification

- **IV1**: Tracking page does not expose sensitive customer data
- **IV2**: Public tracking does not allow data modification
- **IV3**: Token-based access prevents unauthorized viewing
- **IV4**: Tracking page performance acceptable (<1s load time)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] Create tracking tRPC procedure (AC: 1)
  - [ ] Implement `serviceRequest.track` (public, no auth)
  - [ ] Query service_requests by tracking_token
  - [ ] Join with product, physical_product, linked ticket if exists
  - [ ] Return masked customer details for privacy
  - [ ] Return status history/timeline

- [ ] Add privacy masking (AC: 6)
  - [ ] Mask email: show first 3 chars + ***@domain
  - [ ] Mask phone: show last 4 digits only
  - [ ] Return full customer name (they already know it)

### Frontend Tasks

- [ ] Build tracking page (AC: 2)
  - [ ] Create `/app/(public)/service-request/track/page.tsx`
  - [ ] Public layout (no auth required)
  - [ ] Token input form
  - [ ] Display tracking results

- [ ] Implement token input (AC: 3)
  - [ ] Input field with format hint
  - [ ] "Track Request" button
  - [ ] URL parameter support (?token=SR-ABC123XYZ789)
  - [ ] Auto-populate from URL on page load
  - [ ] Format validation

- [ ] Create request status display (AC: 4)
  - [ ] Create `RequestStatusDisplay` component
  - [ ] Product information card
  - [ ] Current status badge
  - [ ] Submission date
  - [ ] Estimated completion date (if available)

- [ ] Build status timeline (AC: 5)
  - [ ] Create `RequestStatusTimeline` component in `src/components/shared/`
  - [ ] Visual timeline with icons
  - [ ] Highlight current status
  - [ ] Show timestamps for each status
  - [ ] Status labels: Submitted, Received, Processing, Completed

- [ ] Display customer details (AC: 6)
  - [ ] Show masked email: j***@example.com
  - [ ] Show masked phone: ****1234
  - [ ] Show full customer name

- [ ] Show linked ticket (AC: 7)
  - [ ] Display ticket number if converted
  - [ ] Link to ticket (if customer has access)
  - [ ] Show "Being processed as ticket SV-2025-001"

- [ ] Create status messages (AC: 8)
  - [ ] Create `StatusMessage` component
  - [ ] Different messages per status:
    - Submitted: "We've received your request..."
    - Received: "Our team is reviewing your request..."
    - Processing: "Your product is being serviced..."
    - Completed: "Your service is complete! ..."
  - [ ] Include next steps for each status

- [ ] Implement auto-refresh (AC: 9)
  - [ ] Use TanStack Query refetchInterval: 30000
  - [ ] Only refetch when page is active/visible
  - [ ] Show "Last updated" timestamp

- [ ] Handle not found case (AC: 10)
  - [ ] Display friendly error message
  - [ ] Suggest checking token format
  - [ ] Provide support contact information

- [ ] URL sharing support (AC: 11)
  - [ ] Accept ?token query parameter
  - [ ] Auto-populate and fetch on load
  - [ ] Update URL when token entered

### Integration & Testing Tasks

- [ ] Test data privacy (IV1)
  - [ ] Access tracking page
  - [ ] Verify email/phone masked
  - [ ] Verify no sensitive data exposed

- [ ] Test read-only access (IV2)
  - [ ] Attempt to modify request via tracking page
  - [ ] Verify no modification endpoints available
  - [ ] Verify only GET requests possible

- [ ] Test token-based security (IV3)
  - [ ] Access without token
  - [ ] Access with invalid token
  - [ ] Verify token required for access

- [ ] Test page performance (IV4)
  - [ ] Load tracking page with token
  - [ ] Measure load time
  - [ ] Verify <1s requirement met

---

## Dev Notes

### Tracking tRPC Procedure

```typescript
// src/server/routers/public/service-request.ts (extend existing)

track: publicProcedure
  .input(z.object({ tracking_token: z.string() }))
  .query(async ({ ctx, input }) => {
    const { data: request, error } = await ctx.supabaseAdmin
      .from('service_requests')
      .select(`
        *,
        product:products(name, brand:brands(name)),
        physical_product:physical_products(serial_number, condition),
        linked_ticket:service_tickets(id, ticket_number, status)
      `)
      .eq('tracking_token', input.tracking_token.toUpperCase())
      .single();

    if (error || !request) {
      return {
        found: false,
        message: 'Request not found. Please check your tracking token and try again.'
      };
    }

    // Mask customer details for privacy
    const maskedEmail = request.customer_email.replace(
      /^(.{3})(.*)(@.*)$/,
      (_, p1, p2, p3) => p1 + '*'.repeat(Math.min(p2.length, 10)) + p3
    );

    const maskedPhone = request.customer_phone.replace(
      /^(.*)(.{4})$/,
      (_, p1, p2) => '*'.repeat(p1.length) + p2
    );

    // Build status timeline
    const timeline = [
      {
        status: 'submitted',
        label: 'Submitted',
        timestamp: request.submitted_at,
        completed: true
      },
      {
        status: 'received',
        label: 'Received',
        timestamp: request.received_at,
        completed: !!request.received_at
      },
      {
        status: 'processing',
        label: 'Processing',
        timestamp: request.processing_started_at,
        completed: !!request.processing_started_at
      },
      {
        status: 'completed',
        label: 'Completed',
        timestamp: request.completed_at,
        completed: !!request.completed_at
      }
    ];

    return {
      found: true,
      request: {
        tracking_token: request.tracking_token,
        status: request.status,
        customer_name: request.customer_name,
        customer_email: maskedEmail,
        customer_phone: maskedPhone,
        problem_description: request.problem_description,
        preferred_delivery_method: request.preferred_delivery_method,
        submitted_at: request.submitted_at,
        estimated_completion: request.estimated_completion_date,
        product: {
          name: request.product.name,
          brand: request.product.brand.name,
          serial: request.physical_product.serial_number,
          condition: request.physical_product.condition
        },
        linked_ticket: request.linked_ticket ? {
          ticket_number: request.linked_ticket.ticket_number,
          status: request.linked_ticket.status
        } : null,
        timeline
      }
    };
  })
```

### Tracking Page

```typescript
// app/(public)/service-request/track/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { RequestStatusTimeline } from '@/components/shared/request-status-timeline';
import { StatusMessage } from '@/components/shared/status-message';
import { useTrackServiceRequest } from '@/hooks/use-service-requests';
import { Search, AlertCircle, Package, Calendar, Truck } from 'lucide-react';
import { formatDate } from '@/utils/date';

export default function TrackServiceRequestPage() {
  const searchParams = useSearchParams();
  const urlToken = searchParams.get('token');

  const [token, setToken] = useState(urlToken || '');
  const [shouldFetch, setShouldFetch] = useState(!!urlToken);

  const { data: trackingData, isLoading, refetch } = useTrackServiceRequest(
    { tracking_token: token },
    {
      enabled: shouldFetch,
      refetchInterval: 30000, // 30 seconds
      refetchIntervalInBackground: false
    }
  );

  useEffect(() => {
    if (urlToken) {
      setToken(urlToken);
      setShouldFetch(true);
    }
  }, [urlToken]);

  const handleTrack = () => {
    if (token) {
      setShouldFetch(true);
      refetch();
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-background to-muted p-8">
      <div className="max-w-4xl mx-auto space-y-6">
        <div className="text-center space-y-2">
          <h1 className="text-4xl font-bold">Track Service Request</h1>
          <p className="text-muted-foreground">
            Enter your tracking token to check your service request status
          </p>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Tracking Token</CardTitle>
            <CardDescription>
              Enter the tracking token from your submission confirmation
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="token">Tracking Token</Label>
              <div className="flex gap-2">
                <Input
                  id="token"
                  placeholder="SR-ABC123XYZ789"
                  value={token}
                  onChange={(e) => setToken(e.target.value.toUpperCase())}
                  onKeyDown={(e) => e.key === 'Enter' && handleTrack()}
                />
                <Button onClick={handleTrack} disabled={!token || isLoading}>
                  <Search className="mr-2 h-4 w-4" />
                  Track
                </Button>
              </div>
            </div>

            {shouldFetch && trackingData && (
              <div className="space-y-6 pt-4">
                {!trackingData.found ? (
                  <Alert variant="destructive">
                    <AlertCircle className="h-4 w-4" />
                    <AlertDescription>{trackingData.message}</AlertDescription>
                  </Alert>
                ) : (
                  <>
                    {/* Status Timeline */}
                    <RequestStatusTimeline timeline={trackingData.request.timeline} />

                    {/* Status Message */}
                    <StatusMessage status={trackingData.request.status} />

                    {/* Request Details */}
                    <div className="grid md:grid-cols-2 gap-4">
                      <Card>
                        <CardHeader>
                          <CardTitle className="text-sm">Product Information</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-2 text-sm">
                          <div className="flex items-center gap-2">
                            <Package className="h-4 w-4 text-muted-foreground" />
                            <div>
                              <p className="font-medium">{trackingData.request.product.name}</p>
                              <p className="text-muted-foreground">
                                {trackingData.request.product.brand} - {trackingData.request.product.serial}
                              </p>
                            </div>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader>
                          <CardTitle className="text-sm">Request Details</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-2 text-sm">
                          <div className="flex items-center gap-2">
                            <Calendar className="h-4 w-4 text-muted-foreground" />
                            <div>
                              <p className="text-muted-foreground">Submitted</p>
                              <p className="font-medium">{formatDate(trackingData.request.submitted_at)}</p>
                            </div>
                          </div>
                          {trackingData.request.estimated_completion && (
                            <div className="flex items-center gap-2">
                              <Calendar className="h-4 w-4 text-muted-foreground" />
                              <div>
                                <p className="text-muted-foreground">Estimated Completion</p>
                                <p className="font-medium">{formatDate(trackingData.request.estimated_completion)}</p>
                              </div>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    </div>

                    {/* Customer Information */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="text-sm">Your Information</CardTitle>
                      </CardHeader>
                      <CardContent className="grid md:grid-cols-3 gap-4 text-sm">
                        <div>
                          <p className="text-muted-foreground">Name</p>
                          <p className="font-medium">{trackingData.request.customer_name}</p>
                        </div>
                        <div>
                          <p className="text-muted-foreground">Email</p>
                          <p className="font-medium font-mono">{trackingData.request.customer_email}</p>
                        </div>
                        <div>
                          <p className="text-muted-foreground">Phone</p>
                          <p className="font-medium font-mono">{trackingData.request.customer_phone}</p>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Linked Ticket */}
                    {trackingData.request.linked_ticket && (
                      <Alert>
                        <AlertDescription>
                          Your request is being processed as service ticket{' '}
                          <strong>{trackingData.request.linked_ticket.ticket_number}</strong>
                        </AlertDescription>
                      </Alert>
                    )}

                    {/* Delivery Method */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="text-sm">Delivery Preference</CardTitle>
                      </CardHeader>
                      <CardContent className="flex items-center gap-2 text-sm">
                        <Truck className="h-4 w-4 text-muted-foreground" />
                        <p className="capitalize">{trackingData.request.preferred_delivery_method}</p>
                      </CardContent>
                    </Card>

                    <p className="text-xs text-muted-foreground text-center">
                      Last updated: {formatDate(new Date())}
                    </p>
                  </>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

### Request Status Timeline Component

```typescript
// src/components/shared/request-status-timeline.tsx

interface TimelineItem {
  status: string;
  label: string;
  timestamp: string | null;
  completed: boolean;
}

interface RequestStatusTimelineProps {
  timeline: TimelineItem[];
}

export function RequestStatusTimeline({ timeline }: RequestStatusTimelineProps) {
  return (
    <div className="relative">
      <div className="absolute left-4 top-8 bottom-8 w-0.5 bg-border" />

      <div className="space-y-6">
        {timeline.map((item, index) => (
          <div key={item.status} className="relative flex items-start gap-4">
            <div
              className={cn(
                'z-10 flex h-8 w-8 items-center justify-center rounded-full border-2',
                item.completed
                  ? 'border-primary bg-primary text-primary-foreground'
                  : 'border-muted-foreground bg-background text-muted-foreground'
              )}
            >
              {item.completed ? (
                <Check className="h-4 w-4" />
              ) : (
                <Circle className="h-4 w-4" />
              )}
            </div>

            <div className="flex-1 pt-1">
              <h3 className={cn(
                'font-semibold',
                item.completed ? 'text-foreground' : 'text-muted-foreground'
              )}>
                {item.label}
              </h3>
              {item.timestamp && (
                <p className="text-sm text-muted-foreground">
                  {formatDate(item.timestamp)}
                </p>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Status Message Component

```typescript
// src/components/shared/status-message.tsx

const STATUS_MESSAGES = {
  submitted: {
    title: 'Request Submitted',
    message: "We've received your service request. Our team will review it within 24 hours.",
    nextSteps: [
      'Check your email for confirmation',
      'Keep your tracking token for future reference',
      'We will contact you if additional information is needed'
    ]
  },
  received: {
    title: 'Request Received',
    message: 'Our team is reviewing your request and will begin processing soon.',
    nextSteps: [
      'No action required at this time',
      'We will update you when processing begins',
      'Estimated review time: 1-2 business days'
    ]
  },
  processing: {
    title: 'Service In Progress',
    message: 'Your product is currently being serviced by our technicians.',
    nextSteps: [
      'Service typically takes 3-5 business days',
      'We will notify you when service is complete',
      'Contact us if you have questions'
    ]
  },
  completed: {
    title: 'Service Complete!',
    message: 'Your service is finished and your product is ready.',
    nextSteps: [
      'Check your email for pickup/delivery details',
      'Bring your tracking token when picking up',
      'Contact us to schedule delivery if applicable'
    ]
  }
};

interface StatusMessageProps {
  status: string;
}

export function StatusMessage({ status }: StatusMessageProps) {
  const messageData = STATUS_MESSAGES[status] || STATUS_MESSAGES.submitted;

  return (
    <Card className="border-l-4 border-l-primary">
      <CardHeader>
        <CardTitle>{messageData.title}</CardTitle>
        <CardDescription>{messageData.message}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          <p className="text-sm font-medium">Next Steps:</p>
          <ul className="text-sm text-muted-foreground list-disc list-inside space-y-1">
            {messageData.nextSteps.map((step, index) => (
              <li key={index}>{step}</li>
            ))}
          </ul>
        </div>
      </CardContent>
    </Card>
  );
}
```

### Testing

**Testing Standards:**
- Follow `docs/architecture/09-testing-strategy.md` when tests are implemented
- Manual testing required for this story

**This Story Testing:**
- **Manual tracking page access** testing
- **Manual token validation** testing
- **Manual status timeline** verification
- **Manual data privacy masking** verification
- **Manual auto-refresh** testing
- **Manual verification** of IV1-IV4

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

---

## QA Results

*This section will be populated by the QA agent after implementation review*
