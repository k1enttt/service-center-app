# Story 1.11: Public Service Request Portal

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.11
**Created:** 2025-10-23
**Status:** ✅ Complete
**Completed:** 2025-10-25 (Verified via code review)
**Depends On:** Story 1.8 (Serial Verification)

---

## Story

**As a** customer,
**I want** to submit a service request online with my product's serial number,
**so that** I can initiate warranty service without visiting the service center.

---

## Acceptance Criteria

1. Table `service_requests` already created by Story 1.1
2. Create public tRPC `serviceRequest` router (no authentication required):
   - `serviceRequest.verifyWarranty` - Verify serial and warranty status (public)
   - `serviceRequest.submit` - Submit service request with customer details
   - `serviceRequest.generateTrackingToken` - Return unique tracking token
3. Request form captures: serial_number, customer name, email, phone, problem_description, preferred_delivery_method (pickup/delivery)
4. Auto-populate product details when serial verified
5. Tracking token generation: 12-character alphanumeric (e.g., SR-ABC123XYZ789)
6. Request status flow: submitted → received → processing → completed
7. Build public portal at `/service-request` (no auth required)
8. Warranty verification before submission (show warranty status, days remaining)
9. Success page displays tracking token prominently with instructions
10. Rate limiting: max 10 requests per IP per hour (via Kong)
11. Client-side validation: serial format, email format, phone format
12. Spam protection: honeypot field + basic CAPTCHA

---

## Integration Verification

- **IV1**: Public portal does not expose authenticated routes
- **IV2**: Service requests do not auto-create service tickets (manual staff conversion)
- **IV3**: Serial verification uses read-only queries, no data modification
- **IV4**: Rate limiting does not affect authenticated API calls

---

## Tasks / Subtasks

### Backend Tasks

- [ ] Create public tRPC router (AC: 2)
  - [ ] Create `src/server/routers/public/service-request.ts`
  - [ ] Implement `serviceRequest.verifyWarranty` (no auth)
  - [ ] Implement `serviceRequest.submit` (no auth)
  - [ ] Implement `serviceRequest.generateTrackingToken` helper
  - [ ] Add router to public routes (bypass auth middleware)

- [ ] Implement tracking token generation (AC: 5)
  - [ ] Create `generate_tracking_token()` PostgreSQL function
  - [ ] Format: SR-[12 random alphanumeric]
  - [ ] Ensure uniqueness check
  - [ ] Trigger on INSERT to service_requests

- [ ] Add request validation (AC: 11)
  - [ ] Serial number format validation
  - [ ] Email format validation (Zod)
  - [ ] Phone format validation
  - [ ] Problem description min 20 characters

- [ ] Implement spam protection (AC: 12)
  - [ ] Add honeypot field validation
  - [ ] Reject if honeypot filled
  - [ ] Optional: integrate simple CAPTCHA (hCaptcha or reCAPTCHA)

- [ ] Configure rate limiting (AC: 10)
  - [ ] Configure Kong rate limiting plugin
  - [ ] Limit: 10 requests per IP per hour
  - [ ] Apply to public service request endpoints only
  - [ ] Return 429 Too Many Requests when exceeded

### Frontend Tasks

- [ ] Create service request type definitions
  - [ ] Create `src/types/service-request.ts`
  - [ ] ServiceRequest interface
  - [ ] RequestStatus enum
  - [ ] TrackingToken interface
  - [ ] DeliveryMethod enum

- [ ] Create service request hooks
  - [ ] Create `src/hooks/use-service-requests.ts`
  - [ ] `useVerifyWarranty()` hook (public)
  - [ ] `useSubmitServiceRequest()` mutation hook (public)

- [ ] Build public portal page (AC: 7)
  - [ ] Create `/app/(public)/service-request/page.tsx`
  - [ ] Public layout (no sidebar/auth)
  - [ ] Brand logo and contact information
  - [ ] Multi-step form: Verify → Details → Submit

- [ ] Build warranty verification step (AC: 4, 8)
  - [ ] Serial number input field
  - [ ] "Verify Warranty" button
  - [ ] Display verification result:
    - Product name and details
    - Warranty status badge
    - Days remaining
    - Eligibility message
  - [ ] Proceed button (enabled only if verified)

- [ ] Build request details form (AC: 3)
  - [ ] Customer name (required)
  - [ ] Email (required, validated)
  - [ ] Phone (required, validated)
  - [ ] Problem description (textarea, min 20 chars)
  - [ ] Preferred delivery method (radio: Pickup/Delivery)
  - [ ] Delivery address (conditional, shown if delivery selected)
  - [ ] Honeypot field (hidden via CSS)

- [ ] Build success page (AC: 9)
  - [ ] Create `/app/(public)/service-request/success/page.tsx`
  - [ ] Display tracking token prominently (large, copyable)
  - [ ] Instructions: "Save this token to track your request"
  - [ ] Link to tracking page
  - [ ] Option to receive token via email

- [ ] Implement client validation (AC: 11)
  - [ ] Serial format: alphanumeric, min 5 chars
  - [ ] Email format: valid email regex
  - [ ] Phone format: valid phone number (international or local)
  - [ ] Problem description: min 20 characters
  - [ ] Real-time validation feedback

- [ ] Add spam protection UI (AC: 12)
  - [ ] Hidden honeypot field (CSS: position: absolute; left: -9999px)
  - [ ] Optional: CAPTCHA widget
  - [ ] Error message for spam detection

- [ ] Create service request constants
  - [ ] Define in `src/constants/service-request.ts`
  - [ ] Request status labels
  - [ ] Delivery method options
  - [ ] Validation patterns

### Database Tasks

- [ ] Create tracking token trigger (AC: 5)
  - [ ] Create trigger function
  - [ ] Generate unique 12-char token
  - [ ] Format: SR-XXXXXXXXXXXX

- [ ] Add RLS policies for service_requests
  - [ ] Public INSERT policy (allow anonymous submission)
  - [ ] Staff READ policy (authenticated staff only)
  - [ ] No public READ policy (customers use tracking page)

### Infrastructure Tasks

- [ ] Configure Kong rate limiting (AC: 10)
  - [ ] Add rate-limiting plugin to public endpoints
  - [ ] Configuration: 10 requests / hour / IP
  - [ ] Exclude authenticated endpoints

### Integration & Testing Tasks

- [ ] Test public access isolation (IV1)
  - [ ] Access public portal without auth
  - [ ] Verify no authenticated routes exposed
  - [ ] Verify no sensitive data visible

- [ ] Test manual ticket conversion (IV2)
  - [ ] Submit service request
  - [ ] Verify no auto-ticket creation
  - [ ] Verify request awaits staff action

- [ ] Test read-only verification (IV3)
  - [ ] Verify serial number
  - [ ] Check database for modifications
  - [ ] Verify only SELECT queries executed

- [ ] Test rate limiting (IV4)
  - [ ] Submit 11 requests from same IP
  - [ ] Verify 11th request blocked
  - [ ] Verify authenticated API calls unaffected

---

## Dev Notes

### Tracking Token Generation Function

```sql
CREATE OR REPLACE FUNCTION generate_tracking_token()
RETURNS TRIGGER AS $$
DECLARE
  v_token VARCHAR(15);
  v_characters VARCHAR(36) := 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  v_token_exists BOOLEAN;
BEGIN
  -- Skip if tracking_token already set
  IF NEW.tracking_token IS NOT NULL THEN
    RETURN NEW;
  END IF;

  -- Generate unique token
  LOOP
    -- Generate 12 random characters
    v_token := 'SR-';
    FOR i IN 1..12 LOOP
      v_token := v_token || SUBSTRING(v_characters FROM (FLOOR(RANDOM() * 36) + 1)::INT FOR 1);
    END LOOP;

    -- Check uniqueness
    SELECT EXISTS(
      SELECT 1 FROM service_requests WHERE tracking_token = v_token
    ) INTO v_token_exists;

    EXIT WHEN NOT v_token_exists;
  END LOOP;

  NEW.tracking_token := v_token;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger
CREATE TRIGGER trigger_generate_tracking_token
  BEFORE INSERT ON service_requests
  FOR EACH ROW
  EXECUTE FUNCTION generate_tracking_token();
```

### Public tRPC Router

```typescript
// src/server/routers/public/service-request.ts

import { router, publicProcedure } from '../../trpc';
import { TRPCError } from '@trpc/server';
import { z } from 'zod';
import { getWarrantyStatus, getRemainingDays } from '@/utils/warranty';

const submitRequestSchema = z.object({
  serial_number: z.string().min(5).regex(/^[A-Z0-9]+$/),
  customer_name: z.string().min(2),
  customer_email: z.string().email(),
  customer_phone: z.string().min(10),
  problem_description: z.string().min(20),
  preferred_delivery_method: z.enum(['pickup', 'delivery']),
  delivery_address: z.string().optional(),
  honeypot: z.string().optional() // Spam protection
});

export const serviceRequestRouter = router({
  verifyWarranty: publicProcedure
    .input(z.object({ serial_number: z.string() }))
    .query(async ({ ctx, input }) => {
      const { data: product, error } = await ctx.supabaseAdmin
        .from('physical_products')
        .select(`
          serial_number,
          warranty_start_date,
          warranty_end_date,
          condition,
          product:products(name, brand:brands(name), warranty_months)
        `)
        .eq('serial_number', input.serial_number.toUpperCase())
        .single();

      if (error || !product) {
        return {
          found: false,
          message: 'Serial number not found. Please check and try again.'
        };
      }

      const warrantyStatus = getWarrantyStatus(product.warranty_end_date);
      const daysRemaining = product.warranty_end_date
        ? getRemainingDays(product.warranty_end_date)
        : null;

      const eligible = warrantyStatus === 'active' || warrantyStatus === 'expiring_soon';

      return {
        found: true,
        eligible,
        product: {
          name: product.product.name,
          brand: product.product.brand.name,
          serial: product.serial_number
        },
        warranty: {
          status: warrantyStatus,
          daysRemaining,
          startDate: product.warranty_start_date,
          endDate: product.warranty_end_date
        },
        message: eligible
          ? 'Your product is eligible for warranty service.'
          : 'Your warranty has expired. Paid service options available.'
      };
    }),

  submit: publicProcedure
    .input(submitRequestSchema)
    .mutation(async ({ ctx, input }) => {
      // Spam protection: check honeypot
      if (input.honeypot && input.honeypot.length > 0) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'Invalid submission'
        });
      }

      // Verify delivery address if delivery method selected
      if (input.preferred_delivery_method === 'delivery' && !input.delivery_address) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'Delivery address required for delivery method'
        });
      }

      // Find product to link
      const { data: product } = await ctx.supabaseAdmin
        .from('physical_products')
        .select('id, product_id')
        .eq('serial_number', input.serial_number.toUpperCase())
        .single();

      if (!product) {
        throw new TRPCError({
          code: 'NOT_FOUND',
          message: 'Serial number not found'
        });
      }

      // Create service request
      const { data: request, error } = await ctx.supabaseAdmin
        .from('service_requests')
        .insert({
          serial_number: input.serial_number.toUpperCase(),
          product_id: product.product_id,
          physical_product_id: product.id,
          customer_name: input.customer_name,
          customer_email: input.customer_email,
          customer_phone: input.customer_phone,
          problem_description: input.problem_description,
          preferred_delivery_method: input.preferred_delivery_method,
          delivery_address: input.delivery_address,
          status: 'submitted',
          submitted_at: new Date().toISOString()
        })
        .select()
        .single();

      if (error) throw new TRPCError({ code: 'INTERNAL_SERVER_ERROR', message: error.message });

      return {
        success: true,
        tracking_token: request.tracking_token,
        request_id: request.id
      };
    })
});
```

### Public Service Request Page

```typescript
// app/(public)/service-request/page.tsx

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useVerifyWarranty, useSubmitServiceRequest } from '@/hooks/use-service-requests';
import { WarrantyStatusBadge } from '@/components/shared/warranty-status-badge';
import { CheckCircle, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';

export default function ServiceRequestPage() {
  const router = useRouter();
  const [step, setStep] = useState(1);

  // Step 1: Serial verification
  const [serial, setSerial] = useState('');
  const [verificationResult, setVerificationResult] = useState<any>(null);
  const { mutate: verifyWarranty, isPending: isVerifying } = useVerifyWarranty();

  // Step 2: Customer details
  const [customerName, setCustomerName] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [problemDescription, setProblemDescription] = useState('');
  const [deliveryMethod, setDeliveryMethod] = useState<'pickup' | 'delivery'>('pickup');
  const [deliveryAddress, setDeliveryAddress] = useState('');
  const [honeypot, setHoneypot] = useState(''); // Spam protection

  const { mutate: submitRequest, isPending: isSubmitting } = useSubmitServiceRequest();

  const handleVerify = () => {
    verifyWarranty({ serial_number: serial }, {
      onSuccess: (result) => {
        setVerificationResult(result);
      },
      onError: () => {
        toast.error('Failed to verify serial number');
      }
    });
  };

  const handleSubmit = () => {
    submitRequest({
      serial_number: serial,
      customer_name: customerName,
      customer_email: email,
      customer_phone: phone,
      problem_description: problemDescription,
      preferred_delivery_method: deliveryMethod,
      delivery_address: deliveryMethod === 'delivery' ? deliveryAddress : undefined,
      honeypot
    }, {
      onSuccess: (result) => {
        router.push(`/service-request/success?token=${result.tracking_token}`);
      },
      onError: (error) => {
        toast.error(error.message || 'Failed to submit request');
      }
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-background to-muted p-8">
      <div className="max-w-2xl mx-auto space-y-6">
        <div className="text-center space-y-2">
          <h1 className="text-4xl font-bold">Service Request Portal</h1>
          <p className="text-muted-foreground">
            Submit a warranty service request online
          </p>
        </div>

        {/* Step 1: Serial Verification */}
        {step === 1 && (
          <Card>
            <CardHeader>
              <CardTitle>Step 1: Verify Your Product</CardTitle>
              <CardDescription>
                Enter your product's serial number to check warranty status
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label htmlFor="serial">Serial Number</Label>
                <div className="flex gap-2">
                  <Input
                    id="serial"
                    placeholder="ABC123456"
                    value={serial}
                    onChange={(e) => setSerial(e.target.value.toUpperCase())}
                    onKeyDown={(e) => e.key === 'Enter' && handleVerify()}
                  />
                  <Button onClick={handleVerify} disabled={!serial || isVerifying}>
                    Verify
                  </Button>
                </div>
              </div>

              {verificationResult && (
                <div>
                  {!verificationResult.found ? (
                    <Alert variant="destructive">
                      <AlertCircle className="h-4 w-4" />
                      <AlertDescription>{verificationResult.message}</AlertDescription>
                    </Alert>
                  ) : (
                    <div className="border rounded-lg p-4 space-y-3">
                      <div className="flex items-center justify-between">
                        <div>
                          <h3 className="font-semibold">{verificationResult.product.name}</h3>
                          <p className="text-sm text-muted-foreground">
                            {verificationResult.product.brand} - {verificationResult.product.serial}
                          </p>
                        </div>
                        <WarrantyStatusBadge
                          status={verificationResult.warranty.status}
                          daysRemaining={verificationResult.warranty.daysRemaining}
                        />
                      </div>

                      <Alert variant={verificationResult.eligible ? 'default' : 'warning'}>
                        <AlertDescription>{verificationResult.message}</AlertDescription>
                      </Alert>

                      <Button className="w-full" onClick={() => setStep(2)}>
                        Continue to Request Form
                      </Button>
                    </div>
                  )}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Step 2: Request Details */}
        {step === 2 && (
          <Card>
            <CardHeader>
              <CardTitle>Step 2: Request Details</CardTitle>
              <CardDescription>
                Provide your contact information and describe the issue
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label htmlFor="name">Full Name *</Label>
                <Input
                  id="name"
                  value={customerName}
                  onChange={(e) => setCustomerName(e.target.value)}
                  required
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="email">Email *</Label>
                  <Input
                    type="email"
                    id="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="phone">Phone *</Label>
                  <Input
                    type="tel"
                    id="phone"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value)}
                    required
                  />
                </div>
              </div>

              <div>
                <Label htmlFor="problem">Problem Description *</Label>
                <Textarea
                  id="problem"
                  placeholder="Describe the issue you're experiencing..."
                  value={problemDescription}
                  onChange={(e) => setProblemDescription(e.target.value)}
                  rows={4}
                  required
                />
                {problemDescription.length > 0 && problemDescription.length < 20 && (
                  <p className="text-sm text-destructive mt-1">
                    Minimum 20 characters required ({problemDescription.length}/20)
                  </p>
                )}
              </div>

              <div>
                <Label>Preferred Delivery Method *</Label>
                <RadioGroup value={deliveryMethod} onValueChange={(v) => setDeliveryMethod(v as any)}>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value="pickup" id="pickup" />
                    <Label htmlFor="pickup">I will pick up from service center</Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <RadioGroupItem value="delivery" id="delivery" />
                    <Label htmlFor="delivery">Deliver to my address</Label>
                  </div>
                </RadioGroup>
              </div>

              {deliveryMethod === 'delivery' && (
                <div>
                  <Label htmlFor="address">Delivery Address *</Label>
                  <Textarea
                    id="address"
                    placeholder="Street, City, ZIP"
                    value={deliveryAddress}
                    onChange={(e) => setDeliveryAddress(e.target.value)}
                    rows={3}
                    required
                  />
                </div>
              )}

              {/* Honeypot field (hidden) */}
              <input
                type="text"
                name="website"
                value={honeypot}
                onChange={(e) => setHoneypot(e.target.value)}
                style={{ position: 'absolute', left: '-9999px' }}
                tabIndex={-1}
                autoComplete="off"
              />

              <div className="flex gap-2">
                <Button variant="outline" onClick={() => setStep(1)}>
                  Back
                </Button>
                <Button
                  className="flex-1"
                  onClick={handleSubmit}
                  disabled={
                    !customerName ||
                    !email ||
                    !phone ||
                    problemDescription.length < 20 ||
                    (deliveryMethod === 'delivery' && !deliveryAddress) ||
                    isSubmitting
                  }
                >
                  Submit Request
                </Button>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
```

### Success Page

```typescript
// app/(public)/service-request/success/page.tsx

'use client';

import { useSearchParams } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { CheckCircle, Copy } from 'lucide-react';
import { toast } from 'sonner';
import Link from 'next/link';

export default function ServiceRequestSuccessPage() {
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const handleCopy = () => {
    navigator.clipboard.writeText(token || '');
    toast.success('Tracking token copied to clipboard');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-background to-muted p-8">
      <div className="max-w-2xl mx-auto">
        <Card>
          <CardHeader className="text-center">
            <div className="flex justify-center mb-4">
              <CheckCircle className="h-16 w-16 text-green-500" />
            </div>
            <CardTitle className="text-2xl">Request Submitted Successfully!</CardTitle>
            <CardDescription>
              Your service request has been received. Please save your tracking token.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <Alert>
              <AlertDescription>
                <strong>Important:</strong> Save this tracking token to check your request status.
                You will also receive a confirmation email.
              </AlertDescription>
            </Alert>

            <div className="border-2 border-primary rounded-lg p-6 text-center space-y-4">
              <p className="text-sm text-muted-foreground">Your Tracking Token:</p>
              <div className="font-mono text-3xl font-bold text-primary">
                {token}
              </div>
              <Button onClick={handleCopy} variant="outline" className="w-full">
                <Copy className="mr-2 h-4 w-4" />
                Copy Token
              </Button>
            </div>

            <div className="space-y-2 text-sm">
              <h3 className="font-semibold">What happens next?</h3>
              <ol className="list-decimal list-inside space-y-1 text-muted-foreground">
                <li>Our team will review your request within 24 hours</li>
                <li>You'll receive an email confirmation with next steps</li>
                <li>Track your request status anytime using your tracking token</li>
              </ol>
            </div>

            <div className="flex flex-col gap-2">
              <Link href={`/service-request/track?token=${token}`}>
                <Button className="w-full">Track My Request</Button>
              </Link>
              <Link href="/service-request">
                <Button variant="outline" className="w-full">Submit Another Request</Button>
              </Link>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

### Testing

**Testing Standards:**
- Follow `docs/architecture/09-testing-strategy.md` when tests are implemented
- Manual testing required for this story

**This Story Testing:**
- **Manual public portal access** testing
- **Manual serial verification** testing
- **Manual request submission** testing
- **Manual spam protection** testing
- **Manual rate limiting** testing (11 requests)
- **Manual verification** of IV1-IV4

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

---

## QA Results

*This section will be populated by the QA agent after implementation review*
