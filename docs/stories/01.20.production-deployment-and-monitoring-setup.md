# Story 1.20: Production Deployment and Monitoring Setup

**Epic:** EPIC-01 - Service Center Phase 2 - Workflow, Warranty & Warehouse
**Story ID:** SC-PHASE2-01.20
**Created:** 2025-10-23
**Status:** Draft
**Depends On:** Story 1.19 (Documentation)

---

## Story

**As a** system administrator,
**I want** a safe production deployment process with monitoring and rollback capability,
**so that** Phase 2 launches successfully with minimal risk.

---

## Acceptance Criteria

1. Pre-deployment checklist:
   - All IV criteria from Stories 1.1-1.19 verified
   - Database backup created
   - Migration scripts tested on staging
   - Rollback plan documented
   - Team notified of deployment window
2. Deployment steps:
   - Apply database migrations (all Phase 2 tables, triggers, views)
   - Deploy Next.js application
   - Verify all Supabase services running
   - Run post-deployment smoke tests
3. Monitoring setup:
   - Configure Supabase Logflare for error tracking
   - Set up alerts for: database errors, API failures, email failures, rate limit breaches
   - Monitor NFR1 (latency), NFR5 (uptime), NFR14 (rate limiting)
4. Create monitoring dashboard in Supabase Studio
5. Set up health check endpoint at `/api/health`
6. Configure backup schedule (daily database backups)
7. Document rollback procedure (database + application)
8. Staff training session before go-live
9. Phased rollout: Enable public portal 24h after staff features stable
10. Post-deployment verification: All 7 business goals (G1-G7) achievable

---

## Integration Verification

- **IV1**: Deployment does not cause downtime for existing features
- **IV2**: Rollback procedure tested and documented
- **IV3**: Monitoring catches errors without false positives
- **IV4**: All staff trained and ready to use new features

---

## Tasks / Subtasks

### Pre-Deployment Tasks
- [ ] Complete pre-deployment checklist
- [ ] Create production database backup
- [ ] Test migrations on staging
- [ ] Document rollback procedure
- [ ] Schedule deployment window (low-traffic period)

### Deployment Tasks
- [ ] Apply database migrations
- [ ] Deploy application to production
- [ ] Verify Supabase services
- [ ] Run smoke tests

### Monitoring Tasks
- [ ] Configure Logflare alerts
- [ ] Set up monitoring dashboard
- [ ] Create health check endpoint
- [ ] Configure backup schedule

### Post-Deployment Tasks
- [ ] Conduct staff training
- [ ] Enable public portal (phased)
- [ ] Monitor metrics for 7 days
- [ ] Verify business goals achievable

---

## Dev Notes

**Deployment Sequence:**
1. Backup database
2. Run migrations: `pnpx supabase db push`
3. Deploy application: `pnpm build && pnpm start`
4. Smoke tests: Create ticket, execute task, submit service request
5. Monitor for 1 hour before announcing to staff

**Rollback Procedure:**
- Revert database: Restore from backup + run DOWN migrations
- Revert application: Redeploy previous version
- Maximum rollback time: 15 minutes

**Monitoring Metrics:**
- API response time (P95 < 500ms)
- Error rate (< 1%)
- Database query time (< 200ms)
- Email delivery rate (> 95%)
- Public portal rate limit hits

**Health Check Endpoint:**
```typescript
// app/api/health/route.ts
export async function GET() {
  // Check database connection
  // Check Supabase services
  // Return status: healthy/degraded/down
  return Response.json({ status: 'healthy', timestamp: new Date() });
}
```

**Business Goals Verification:**
- G1: Task workflow reduces errors (monitor task completion rate)
- G2: Technician onboarding faster (time to first completed task)
- G3: Warranty verification accurate (serial verification success rate)
- G4: Inventory stockouts reduced (low stock alert response time)
- G5: 24/7 self-service enabled (public portal usage metrics)
- G6: Task-level visibility (manager dashboard usage)
- G7: RMA workflow established (RMA batch creation count)

**Testing:** Deployment rehearsal on staging, post-deployment verification

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation | John (PM) |

---

## Epic Completion

**Status**: All 20 stories (1.1-1.20) complete
**Total Estimated Effort**: 324-404 hours
**Ready for Implementation**: Yes
